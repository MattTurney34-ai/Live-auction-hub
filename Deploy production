#!/bin/bash

# ============================================
# PRODUCTION DEPLOYMENT SCRIPT
# Live Auction Hub - Deploy to Production
# ============================================

set -e  # Exit on error

echo "üöÄ Starting Production Deployment Process"
echo "=========================================="
echo ""

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Step 1: Confirmation prompt
echo "${RED}‚ö†Ô∏è  WARNING: You are about to deploy to PRODUCTION!${NC}"
echo ""
read -p "Are you sure you want to continue? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "${YELLOW}Deployment cancelled.${NC}"
    exit 0
fi

# Step 2: Check if EAS CLI is installed
echo ""
echo "üì¶ Checking EAS CLI installation..."
if ! command -v eas &> /dev/null
then
    echo "${RED}‚ùå EAS CLI not found. Installing...${NC}"
    npm install -g eas-cli
else
    echo "${GREEN}‚úÖ EAS CLI is installed${NC}"
fi

# Step 3: Verify EAS login
echo ""
echo "üîê Verifying EAS authentication..."
if ! eas whoami &> /dev/null
then
    echo "${YELLOW}‚ö†Ô∏è  Not logged in to EAS. Please log in:${NC}"
    eas login
else
    CURRENT_USER=$(eas whoami 2>&1)
    echo "${GREEN}‚úÖ Authenticated as: ${CURRENT_USER}${NC}"
fi

# Step 4: Switch to production environment
echo ""
echo "üîß Switching to production environment..."
if [ ! -f .env.production ]; then
    echo "${RED}‚ùå .env.production not found!${NC}"
    echo "Please create .env.production before deploying to production."
    exit 1
fi
cp .env.production .env
echo "${GREEN}‚úÖ Production environment activated${NC}"

# Step 5: Install dependencies
echo ""
echo "üì¶ Installing dependencies..."
npm install
echo "${GREEN}‚úÖ Dependencies installed${NC}"

# Step 6: Run comprehensive pre-deployment checks
echo ""
echo "üîç Running comprehensive pre-deployment checks..."

echo "   - TypeScript type checking..."
if ! npm run type-check; then
    echo "${RED}‚ùå Type check failed! Fix errors before deploying to production.${NC}"
    exit 1
fi

echo "   - Linting code..."
if ! npm run lint; then
    echo "${RED}‚ùå Linting failed! Fix errors before deploying to production.${NC}"
    exit 1
fi

echo "   - Running tests..."
npm run test || echo "${YELLOW}‚ö†Ô∏è  Tests not configured${NC}"

echo "${GREEN}‚úÖ All pre-deployment checks passed${NC}"

# Step 7: Final confirmation
echo ""
echo "${YELLOW}Final confirmation required:${NC}"
read -p "Deploy to PRODUCTION? This cannot be undone. (YES to confirm): " final_confirm

if [ "$final_confirm" != "YES" ]; then
    echo "${YELLOW}Deployment cancelled.${NC}"
    exit 0
fi

# Step 8: Build for production
echo ""
echo "üèóÔ∏è  Building application for production..."
echo "${YELLOW}Choose platform:${NC}"
echo "  1) iOS"
echo "  2) Android"
echo "  3) Both (iOS + Android)"
read -p "Enter choice [1-3]: " platform_choice

case $platform_choice in
    1)
        echo ""
        echo "${GREEN}Building for iOS (Production)...${NC}"
        eas build --profile production --platform ios
        ;;
    2)
        echo ""
        echo "${GREEN}Building for Android (Production)...${NC}"
        eas build --profile production --platform android
        ;;
    3)
        echo ""
        echo "${GREEN}Building for iOS + Android (Production)...${NC}"
        eas build --profile production --platform all
        ;;
    *)
        echo "${RED}Invalid choice. Exiting.${NC}"
        exit 1
        ;;
esac

# Step 9: Completion
echo ""
echo "=========================================="
echo "${GREEN}‚úÖ Production Deployment Initiated!${NC}"
echo "=========================================="
echo ""
echo "üì± Next Steps:"
echo "   1. Monitor build: https://expo.dev"
echo "   2. Wait for build completion"
echo "   3. Submit to App Store / Play Store"
echo "   4. Monitor crash reports and analytics"
echo ""
echo "üí° Useful Commands:"
echo "   - Check build status: eas build:list --profile production"
echo "   - Submit to stores: eas submit --profile production"
echo "   - Push OTA update: npm run update:production"
echo ""
